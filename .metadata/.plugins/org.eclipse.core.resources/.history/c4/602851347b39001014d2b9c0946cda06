#include "stm32f407xx.h"
#include "MPU6050.h"


#define SystemCoreClock 16000000

void Error_Handler(void);
I2C_HandleTypeDef hi2c1;
MPU6050_Data sensor_data;
MPU6050_ConvertedData converted_data;
double test;
void DWT_Init(void)
{
    DEMCR |= DEMCR_TRCENA;         // Enable trace (cần thiết để DWT hoạt động)
    DWT_CYCCNT = 0;                // Reset counter
    DWT_CTRL |= DWT_CTRL_CYCCNTENA; // Enable cycle counter
}
int main(void){
	DWT_Init();

	I2C1_Init(&hi2c1);
	if (MPU6050_Init(&hi2c1) != I2C_OK)
	{
		Error_Handler();
	}

	uint32_t prev = DWT_CYCCNT;

	while (1)
	{
		uint32_t now = DWT_CYCCNT;
		float dt = (now - prev) / (float)SystemCoreClock; // đơn vị: giây
		prev = now;

		if (MPU6050_ReadData(&hi2c1, &sensor_data) == I2C_OK)
		{
			MPU6050_ConvertData(&sensor_data, &converted_data);
			test = MPU6050_GetAngle(&converted_data, test, dt);
		}
	}
}

void Error_Handler(void)
{
	while(1)
}
