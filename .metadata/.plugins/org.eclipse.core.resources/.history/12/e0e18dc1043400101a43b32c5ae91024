/*
 * SR05.c
 *
 *  Created on: May 18, 2025
 *      Author: quanvm198
 */


#include "SR05.h"
#include "stm32f407xx.h"


void SR05_InitTriggerIO(){
  GPIO_Initialize(GPIOA, GPIO_PIN_0, GPIO_MODE_OUTPUT);
}

void SR05_Trigger(){
  GPIO_WritePin(GPIOA, GPIO_PIN_0, 0);
//  Delay_ms(20);
//  GPIO_WritePin(GPIOA, GPIO_PIN_0, 1);
//  Delay_ms(18);
}

uint16_t SR05_ReadData(USART_HandleTypeDef* pUSART){
  SR05_Trigger();
  uint16_t distance = 0;

  uint8_t pRxBuffer[4];
  for(uint8_t count = 0; count < 5; count++){
      USART_Receive(pUSART, pRxBuffer, 4);
      if(pRxBuffer[0] == 0xff){
	  if(pRxBuffer[1] == 0xAA && pRxBuffer[2] == 0xAA) return 1;
	  distance = (uint16_t)(pRxBuffer[1] << 8) | pRxBuffer[2];
	  break;
      }
  }
  //USART_Receive(pUSART, pRxBuffer, 4);

  //uint8_t Received_Value_Sum = 0;

//  if(pRxBuffer[0] == 0xff){
//      if(pRxBuffer[1] == 0xAA && pRxBuffer[2] == 0xAA) return 1;
//
//      //Received_Value_Sum = (pRxBuffer[0] + pRxBuffer[1] + pRxBuffer[2]) & 0xFF;
////      if(Received_Value_Sum == pRxBuffer[3]){
////	  distance = (uint16_t)(pRxBuffer[1] << 8) | pRxBuffer[2];
////      }
//      distance = (uint16_t)(pRxBuffer[1] << 8) | pRxBuffer[2];
//  }

  return distance;
}

